name: PyArrow Compatibility Tests

# This workflow tests compatibility with pyarrow 21, 22, and 23 across different
# Python versions, operating systems, and installation methods (pip vs conda).
# Reference: commit 2e5288e pinned pyarrow <22 due to ABI incompatibility concerns.
# This workflow validates that newer versions work correctly with both pip and conda builds.

on:
  push:
    branches: [ main, refactor ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 3 AM UTC to catch any new issues
    - cron: '0 3 * * 1'

permissions:
  contents: read

jobs:
  test-pyarrow-pip:
    name: PyArrow ${{ matrix.pyarrow-version }} - Python ${{ matrix.python-version }} - ${{ matrix.os }} (pip)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11']
        pyarrow-version: ['21.0.0', '22.0.0', '23.0.0']
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip, setuptools, and wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install pyarrow ${{ matrix.pyarrow-version }}
        run: |
          pip install "pyarrow==${{ matrix.pyarrow-version }}"

      - name: Install package with test dependencies
        run: |
          pip install -e .[dev]

      - name: Verify pyarrow version
        run: |
          python -c "import pyarrow; print(f'PyArrow version: {pyarrow.__version__}')"

      - name: Run pytest
        run: |
          pytest -v --tb=short

      - name: Run basic smoke test (read/write GeoParquet)
        run: |
          python .github/scripts/smoke_test.py

  test-pyarrow-conda:
    name: PyArrow ${{ matrix.pyarrow-version }} - Python ${{ matrix.python-version }} - ${{ matrix.os }} (conda)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11']
        pyarrow-version: ['21.0.0', '22.0.0', '23.0.0']
    
    steps:
      - uses: actions/checkout@v6

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.python-version }}
          miniforge-version: latest
          use-mamba: true

      - name: Install pyarrow and dependencies via conda
        shell: bash -el {0}
        run: |
          mamba install -y -c conda-forge python=${{ matrix.python-version }} pyarrow=${{ matrix.pyarrow-version }} pytest

      - name: Install package with test dependencies
        shell: bash -el {0}
        run: |
          pip install -e .[dev]

      - name: Verify pyarrow version
        shell: bash -el {0}
        run: |
          python -c "import pyarrow; print(f'PyArrow version: {pyarrow.__version__}')"

      - name: Run pytest
        shell: bash -el {0}
        run: |
          pytest -v --tb=short

      - name: Run basic smoke test (read/write GeoParquet)
        shell: bash -el {0}
        run: |
          python .github/scripts/smoke_test.py
